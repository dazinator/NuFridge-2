<template>
    <require from="./date-format"></require>
    <div class="ui warning message" if.bind="!canViewPage">
        <div class="header">
            You are not authorized to view feeds.
        </div>
        Contact your System Administrator to request this permission.
    </div>
    <div if.bind="canViewPage">
        <h1 textcontent="${feedName}"></h1>

        <div class="ui pointing secondary menu feedMenu">
            <a class="item active" data-tab="first">Overview</a>
            <a class="item" data-tab="second">Endpoints</a>
            <a class="item" data-tab="third" if.bind="canViewPackages">Packages</a>
            <a class="item" data-tab="fourth" if.bind="canViewFeedHistory">History</a>
            <a class="item settingTab" data-tab="fifth" if.bind="canUpdateFeed">Settings</a>
        </div>

        <div data-tab="first" class="ui bottom tab segment active">
            <h2 class="ui header">
                Statistics
            </h2>

            <div class="ui tiny horizontal statistics">
                <div class="statistic">
                    <div class="value">
                        0
                    </div>
                    <div class="label">
                        Total Packages
                    </div>
                </div>
            </div>

            <h2 class="ui header">
                Background Jobs
            </h2>

            <p>No background jobs are executing for this feed.</p>

            <h2 class="ui header" if.bind="canReindexPackages || canExecuteRetentionPolicy || canChangePackageDirectory">
                Administrative Actions
            </h2>

            <button class="ui button" style="margin-bottom: 0.75em" click.trigger="reindexPackagesClick()" if.bind="canReindexPackages">
                Reindex Packages
            </button>
            <button class="ui button" style="margin-bottom: 0.75em" if.bind="canExecuteRetentionPolicy">
                Execute Package Retention Policy
            </button>
            <button class="ui button" style="margin-bottom: 0.75em" if.bind="canChangePackageDirectory">
                Change Package Directory
            </button>

        </div>


        <div data-tab="second" class="ui bottom tab segment">
            <table class="ui compact table">
                <thead>
                    <tr>
                        <th>URL</th>
                        <th>Usage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><a target="_blank" href="${feed.RootUrl}/api/v2">${feed.RootUrl}/api/v2</a></td>
                        <td>Use this for pushing NuGet packages or querying this NuGet feed.</td>
                    </tr>
                    <tr>
                        <td><a target="_blank" href="${feed.RootUrl}/api/symbols">${feed.RootUrl}/api/symbols</a></td>
                        <td>Use this to access the symbol server for this NuGet feed.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div data-tab="third" class="ui bottom tab segment" if.bind="canViewPackages">
            <div class="stackable five column ui grid">
                <div class="column">
                    <button class="ui basic button labeled icon" style="width: 100%" click.trigger="resetPackageListingClick()">
                        <i class="undo icon"></i>
                        Reset
                    </button>
                </div>
                <div class="column">
                    <select class="ui fluid dropdown pageSizeDropdown" style="width: 100%">
                        <option value="10">10 packages per page</option>
                        <option value="20">20 packages per page</option>
                        <option value="30">30 packages per page</option>
                        <option value="40">40 packages per page</option>
                        <option value="50">50 packages per page</option>
                    </select>
                </div>
                <div class="column">
                    <select class="ui fluid dropdown pageOrderDropdown" style="width: 100%">
                        <option value="0">Downloads descending</option>
                        <option value="1">Downloads ascending</option>
                        <option value="2">Package Id descending</option>
                        <option value="3">Package Id ascending</option>
                    </select>
                </div>
                <div class="column">
                    <div class="ui search" style="width: 100%">
                        <input class="prompt" type="text" placeholder="Search..." style="width: 100%" value.bind="packagesSearchText">

                        <div class="results"></div>
                    </div>
                </div>
                <div class="column">
                    <button class="ui button labeled" style="width: 100%" click.trigger="applyFilterClick()">
                        Apply
                    </button>
                </div>
            </div>

            <div class="ui inverted dimmer ${isLoadingPackages ? 'active' : ''}">
                <div class="ui indeterminate large text loader">Searching for packages</div>
            </div>

            <div class="one column ui grid" if.bind="packagesTotalMatchingQuery == 0">
                <div class="column">
                    <div class="ui message">
                        <p>No packages found.</p>
                    </div>
                </div>
            </div>

            <div class="stackable two column ui grid" if.bind="packagesTotalMatchingQuery > 0">
                <div class="column" style="width: 140px;">

                    <div class="ui floated menu">
                        <div class="item">
                            Page ${packagesCurrentPage} of ${packagesTotalPages.length}
                        </div>
                    </div>

                </div>
                <div class="column">

                    <div class="ui floated pagination menu">
                        <a class="icon item ${packagesCurrentPage == 1 ? 'disabled' : ''}" click.trigger="previousPageClick()">
                            <i class="left chevron icon"></i>
                        </a>
                        <a repeat.for="page of packagesTotalPages" click.trigger="$parent.goToPageClick($index + 1)" class="item ${$parent.packagesCurrentPage == ($index + 1) ? 'active' : ''}">${$index + 1}</a>
                        <a class="icon item ${packagesCurrentPage == packagesTotalPages.length ? 'disabled' : ''}" click.trigger="nextPageClick()">
                            <i class="right chevron icon"></i>
                        </a>
                    </div>
                </div>
            </div>

            <table class="ui basic selectable table" if.bind="packagesTotalMatchingQuery > 0">
                <tbody>
                    <tr repeat.for="package of packagesRecords" style="cursor: pointer;">
                        <td><img src="${package.IconUrl}" width="48" height="48" onerror="this.onerror = null; this.src = 'img/default.png';" /></td>
                        <td><strong>${package.Title}</strong></td>
                        <td>
                            <div class="ui labels">
                                <a class="ui label" repeat.for="author of package.Authors">
                                    ${author}
                                </a>
                            </div>
                        </td>
                        <td>
                            v${package.NormalizedVersion}
                        </td>
                        <td>${package.Description}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div data-tab="fourth" class="ui bottom tab segment" css="${isLoadingHistory ? 'min-height:150px;' : ''}" if.bind="canViewFeedHistory">
            <div class="ui inverted dimmer ${isLoadingHistory ? 'active' : ''}">
                <div class="ui indeterminate large text loader">Loading history</div>
            </div>
            <div class="ui" if.bind="isLoadingHistory === false && historyRecords.length === 0">
                <p>No events have been recorded for this feed yet.</p>
            </div>
            <section id="cd-timeline" class="cd-container" if.bind="historyRecords.length > 0">
                <div class="cd-timeline-block" repeat.for="item of historyRecords">
                    <div class="cd-timeline-img ${item.Type === 0 ? 'cd-silver' : 'cd-blue'}">
                        <i class="inverted big cube icon"></i>
                    </div>

                    <div class="cd-timeline-content">
                        <h3 class="ui header" style="margin: 0;">
                            ${item.Title}
                            <div class="sub header">${item.Description}</div>
                        </h3>
                        <span class="cd-date">${item.Date | dateFormat}</span>
                    </div>
                </div>
            </section>
        </div>

        <div data-tab="fifth" class="ui bottom tab segment settingTab" if.bind="canUpdateFeed">
            <h2 class="ui header">
                General Settings
                <div class="sub header">Manage your general feed settings.</div>
            </h2>
            <div class="ui inverted dimmer ${isUpdatingFeed ? 'active' : ''}">
                <div class="ui indeterminate large text loader">Saving Feed</div>
            </div>
            <form class="ui form">
                <div class="ui segment">
                    <div class="field">
                        <label>Feed Name</label>

                        <p>
                            The feed name is used to generate the feed URL. Changing it will break any applications that access this
                            feed.
                        </p>
                        <input type="text" name="feedname" value.bind="feed.Name">
                    </div>
                </div>

                <h2 class="ui header">
                    Security Settings
                    <div class="sub header">Manage your security settings for accessing this feed.</div>
                </h2>

                <div class="ui segment">
                    <div class="field">
                        <label>API Key</label>
                        <p>When using an API Key you will need to provide it when pushing packages to the feed.</p>
                        <div class="ui input ${feed.HasApiKey === true ? 'action' : ''}">
                            <input type="text" class="apiKeyTextBox" value.bind="feed.ApiKey" placeholder.bind="feed.HasApiKey === true ? 'An API Key has already been set.' : ''" disabled.bind="feed.HasApiKey === true">
                            <button class="ui gray right labeled button" show.bind="feed.HasApiKey === true" click.trigger="clearApiKey()">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <h2 class="ui header">
                    Package Retention Policy Settings
                    <div class="sub header">Manage your package retention settings for this feed.</div>
                </h2>
                <div class="ui segment">
                    <div class="field">
                        <div class="inline field">
                            <div class="ui toggle checkbox retentionPolicyEnabled">
                                <input type="checkbox">
                                <label style="font-size: .9285em; font-weight: 700;">Enable Package Retention Policy</label>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label>Maximum Amount of Release Packages to Keep</label>

                        <p>This defines the amount of versions to keep of each package before deleting the older versions.</p>
                        <input type="text">
                    </div>
                    <div class="field">
                        <label>Maximum Amount of Pre-release Packages to Keep</label>

                        <p>This defines the amount of versions to keep of each package before deleting the older versions.</p>

                        <p>
                            A package is determined to be a pre-release package by appending a hyphen and a series of dot separated
                            identifiers immediately following the patch version.
                        </p>
                        <input type="text">
                    </div>
                </div>
            </form>
            <div style="padding-top: 15px;">
                <div class="ui buttons">
                    <button class="ui positive button" click.trigger="updateFeed()">Save</button>
                </div>

                <div class="ui buttons floatRight">
                    <button class="ui red button" click.trigger="deleteFeedClick()">Delete</button>
                </div>
            </div>
        </div>


        <div class="ui small modal transition hidden" id="deleteConfirmModal">
            <div class="ui icon header">
                <i class="cube icon"></i>
                <span>Delete the '${feedName}' feed?</span>
            </div>
            <div class="content">
                <p style="text-align: center;">Are you sure you want to delete this feed? All packages will be deleted permanently.</p>
            </div>
            <div class="actions">
                <div class="ui black deny button">
                    No
                </div>
                <div class="ui positive right labeled icon button">
                    Yes
                    <i class="checkmark icon"></i>
                </div>
            </div>
        </div>
    </div>
</template>